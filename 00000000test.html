<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MYWAY 인플루언서 influencer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{
      --gap:15px;           /* 카드 간격 */
      --side-pad:12px;      /* 좌우 여백(살짝) */
      --row-unit:6px;       /* Masonry 계산 단위(작을수록 정밀) */
      --radius:12px;
      --shadow:0 8px 22px rgba(0,0,0,.12);
    }

    body { background: #fff; font-family: 'Segoe UI','맑은 고딕','NanumGothic',Arial,sans-serif; margin:0; padding:0;}
    .topbar {
      position: fixed; top: 0; left: 0; width: 100vw; z-index: 1001;
      background: #2e2e54; color: #fff;
      display: flex; align-items: center; justify-content: flex-start;
      box-shadow: 0 4px 18px #29317018;
      padding: 0 14px; height: 54px; min-width: 360px; font-size: 16px;
    }
    .topbar button {
      padding: 8px 18px; margin-right: 8px; background: #436cff; color: #fff;
      border: none; border-radius: 6px; font-size: 15px; cursor: pointer;
      font-family: inherit; transition: background .2s;
    }
    .topbar button#export-btn { background: #30bc8a; }
    .topbar button#import-btn { background: #ffc94a; color: #232356; }
    .topbar select {
      margin-left: 8px; padding: 7px 11px; font-size: 15px; border-radius: 5px; border: 1px solid #ccd;
      background: #fff; color: #232373; min-width: 110px; font-family: inherit;
    }

    /* 대시보드: 시작 위치는 원본 유지 */
    .dashboard {
      width: 100vw; max-width: none; margin: 0; padding: 64px 0 60px 0;
      margin-top: 1200px !important;
      box-sizing: border-box;
    }

    .gallery-label {
      font-weight: bold; font-size: 1.15rem; margin: 34px 0 18px 0;
      color: #232356; text-align: center; letter-spacing: 0.5px; display: block; width: 100%;
    }

    /* ===== Masonry(Grid 기반) ===== */
    .gallery-row{
      display: grid;
      grid-template-columns: repeat(3, 1fr);   /* PC: 3열 */
      grid-auto-rows: var(--row-unit);         /* Masonry 단위 행 높이 */
      gap: var(--gap);
      padding: 0 var(--side-pad);              /* 좌우 살짝 여백 */
      box-sizing: border-box;
    }
    @media (max-width: 1100px){
      .gallery-row{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 700px){
      .gallery-row{ grid-template-columns: 1fr; }
    }

    /* 카드(원래 .list-row.magazine 사용) */
    .list-row{
      position: relative;
      display: block;
      width: 100%;
      margin: 0;                  /* gap으로 간격 관리 */
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      background: #fff;
      /* Masonry: JS가 grid-row-end를 계산해 설정 */
    }
    .imgframe{
      width: 100%;
      height: auto;
      background: #fff;
      position: relative;
      box-sizing: border-box;
      z-index: 0;
      border-radius: 0;
      overflow: hidden;
      display: block;
    }
    .img-wrap{ position: relative; width: 100%; height: auto; overflow: hidden; margin:0; padding:0;}
    .img-item{ position: relative; width: 100%; height: auto; overflow: hidden; }
    .img-item a{ display:block; width:100%; height:auto; }
    .img-item img{
      display: block;
      width: 100%;
      height: auto;              /* 비율 유지 */
      object-fit: contain;
      background: #fff;
      margin: 0; border: none; padding: 0;
      transition: transform .25s ease;
    }
    .list-row:hover .img-item img{ transform: scale(1.02); }

    .edit-btn {
      position: absolute; top: 7px; right: 9px; padding: 4px 12px; font-size: 14px;
      background: #2e2e54c0; color: #fff; border: none; border-radius: 6px; cursor: pointer;
      z-index: 4; transition: background .15s;
    }
    .edit-btn:hover { background: #436cff; }

    /* 하단 그림자 라인은 폭 100%로 */
    .shadow-line { text-align: center; margin: 0; padding: 0; max-width: 100%; overflow: hidden !important;}
    .shadow-line img { display: block; margin: 0; width: 100%; height: 20px; pointer-events: none; user-select: none; }

    /* 기존 고정 크기 규칙 제거(그리드 Masonry에서 auto) */
    .list-row.magazine{ /* height/width 고정값 제거 */ }
    .img-wrap.magazine, .img-item.magazine, .imgframe{ height: auto; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>
  <!-- 상단바 -->
  <nav class="topbar">
    <button id="add-btn">추가</button>
    <button id="export-btn">내보내기</button>
    <button id="import-btn">가져오기</button>
    <input type="file" id="import-file" accept="application/json" style="display:none">
    <select id="page-switch">
      <option value="">Type</option>
      <option value="making001.html">BAR ▼</option>
      <option value="00making77typeshort.html">PIC1 ▼</option>
      <option value="00makingcircletext.html">CIRCLE▼</option>
      <option value="00making10d.html.html">PIC2 ▼</option>
    </select>
  </nav>

  <div class="dashboard">
    <span class="gallery-label">A</span>
    <div class="gallery-row" id="gallery1"></div>
    <span class="gallery-label">B</span>
    <div class="gallery-row" id="gallery2"></div>
    <span class="gallery-label">C</span>
    <div class="gallery-row" id="gallery3"></div>
    <span class="gallery-label">D</span>
    <div class="gallery-row" id="gallery4"></div>
    <span class="gallery-label">E</span>
    <div class="gallery-row" id="gallery5"></div>
    <span class="gallery-label">F</span>
    <div class="gallery-row" id="gallery6"></div>
    <span class="gallery-label">G</span>
    <div class="gallery-row" id="gallery7"></div>
    <span class="gallery-label">H</span>
    <div class="gallery-row" id="gallery8"></div>
    <span class="gallery-label">I</span>
    <div class="gallery-row" id="gallery9"></div>
    <span class="gallery-label">J</span>
    <div class="gallery-row" id="gallery10"></div>
  </div>

  <!-- 입력 모달 -->
  <div id="modal-overlay" style="display:none">
    <div id="modal" style="background:#fff; padding: 28px 22px 22px 22px; border-radius:7px; width:320px; box-shadow:0 2px 16px #24248238;">
      <h3 style="margin-bottom:16px; font-size:20px; color:#313181;">이미지 추가</h3>
      <label style="display:block; margin-bottom:6px; color:#232356; font-weight:600;">이미지 URL</label>
      <input type="text" id="modal-img" placeholder="이미지 주소" style="width:100%; margin-bottom:14px; padding:8px; border:1px solid #b2c1e6; border-radius:5px; font-size:14px;">
      <label style="display:block; margin-bottom:6px; color:#232356; font-weight:600;">링크 URL</label>
      <input type="text" id="modal-link" placeholder="연결될 링크 주소" style="width:100%; margin-bottom:14px; padding:8px; border:1px solid #b2c1e6; border-radius:5px; font-size:14px;">
      <label style="display:block; margin-bottom:6px; color:#232356; font-weight:600;">분류(디렉토리)</label>
      <select id="modal-dir" style="width:100%; margin-bottom:14px; padding:8px; border:1px solid #b2c1e6; border-radius:5px; font-size:14px;">
        <option value="gallery1">A</option>
        <option value="gallery2">B</option>
        <option value="gallery3">C</option>
        <option value="gallery4">D</option>
        <option value="gallery5">E</option>
        <option value="gallery6">F</option>
        <option value="gallery7">G</option>
        <option value="gallery8">H</option>
        <option value="gallery9">I</option>
        <option value="gallery10">J</option>
      </select>
      <div class="actions" style="text-align:right;">
        <button class="cancel-btn" type="button" style="padding:8px 14px; border:none; border-radius:4px; cursor:pointer; margin-left:8px; font-size:15px; background:#dc3545; color:#fff;">취소</button>
        <button class="save-btn" type="button" style="padding:8px 14px; border:none; border-radius:4px; cursor:pointer; margin-left:8px; font-size:15px; background:#4067d1; color:#fff;">저장</button>
      </div>
    </div>
  </div>

  <script>
    // 페이지 이동
    document.getElementById('page-switch').addEventListener('change', function() {
      if (this.value) location.href = this.value;
    });

    // ===== Storage Key 네임스페이스 (페이지별 분리) =====
    const STORAGE_NAMESPACE = "MW_INFLUENCER_GALLERY_v3";
    const PAGE_ID = (location.pathname.split('/').pop() || 'index').toLowerCase();
    const STORAGE_KEY = `${STORAGE_NAMESPACE}:${PAGE_ID}`;
    // ================================================

    const defaultData = {
      gallery1: [
        { url: "https://www.youtube.com/@popcorncokemovie/videos", img: "https://yt3.googleusercontent.com/4vsl0dMmf2_zJh9hNMoFP7KPnfxEKCeWSn5iYdQvuJUVUkBf9eFu3qqdHWIN1DDULygUcGDmww=s900-c-k-c0x00ffffff-no-rj" },
      ],
      gallery2: [], gallery3: [], gallery4: [], gallery5: [],
      gallery6: [], gallery7: [], gallery8: [], gallery9: [], gallery10: []
    };
    const shadowUrl = "https://64.media.tumblr.com/f5f06009df6584ebb5539cad61f73c63/tumblr_inline_qsghz3XZRQ1r45nlo_500.png";

    const $ = (sel,root=document)=>root.querySelector(sel);
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

    function getData() {
      let data = localStorage.getItem(STORAGE_KEY);
      if (!data) return JSON.parse(JSON.stringify(defaultData));
      try { return JSON.parse(data); }
      catch { return JSON.parse(JSON.stringify(defaultData)); }
    }
    function setData(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

    let editing = { gallery: null, index: null };

    // Masonry 높이 계산: 각 카드 실제 높이 기준으로 grid-row span 지정
    function sizeMasonry(container){
      const rowUnit = parseInt(getComputedStyle(container).getPropertyValue('--row-unit')) || 6;
      const gap = parseInt(getComputedStyle(container).gap) || 0;

      $$('.list-row', container).forEach(card=>{
        // 카드의 실제 총 높이(그림자 라인 포함)
        const imgBox = $('.imgframe', card);
        const shadow = $('.shadow-line', card);
        const total = (imgBox?.offsetHeight || 0) + (shadow?.offsetHeight || 0) + gap;
        const span = Math.ceil(total / rowUnit);
        card.style.gridRowEnd = `span ${span}`;
      });
    }
    function sizeAllMasonry(){
      for(let i=1;i<=10;i++){
        const container = $(`#gallery${i}`);
        if(container) sizeMasonry(container);
      }
    }

    // 이미지 로드 이벤트로 Masonry 재계산
    function bindImgLoadReflow(scope=document){
      $$('img', scope).forEach(img=>{
        if (img.complete) return; // 이미 로드됨
        img.addEventListener('load', ()=> {
          const row = img.closest('.gallery-row');
          if(row) sizeMasonry(row);
        });
      });
    }

    function renderGallery(data, targetId) {
      const el = document.getElementById(targetId);

      // 저장 순서대로 DOM 생성 (순서 유지)
      el.innerHTML = data.map((item, idx) => `
        <div class="list-row magazine" data-idx="${idx}">
          <div class="imgframe">
            <button class="edit-btn" type="button" title="수정">수정</button>
            <div class="img-wrap magazine">
              <div class="img-item magazine">
                <a href="${item.url}" target="_blank" rel="noopener">
                  <img src="${item.img}" alt="">
                </a>
              </div>
            </div>
          </div>
          <div class="shadow-line">
            <img src="${shadowUrl}" alt="">
          </div>
        </div>
      `).join('');

      // 수정 버튼 동작
      Array.from(el.querySelectorAll('.edit-btn')).forEach((btn, idx) => {
        btn.onclick = function(e) {
          e.stopPropagation();
          editing.gallery = targetId;
          editing.index = idx;
          const data = getData();
          const item = data[targetId][idx];
          document.getElementById('modal-img').value = item.img;
          document.getElementById('modal-link').value = item.url;
          document.getElementById('modal-dir').value = targetId;
          document.getElementById('modal-overlay').style.display = 'flex';
        };
      });

      // 드래그로 재정렬 (수동으로 순서 바꾸면 저장 및 재렌더 시 그 순서 유지)
      Sortable.create(el, {
        animation: 160,
        handle: ".imgframe",
        ghostClass: "drag-ghost",
        onEnd: function (evt) {
          let galleryKey = targetId;
          let galleryData = getData();
          const moved = galleryData[galleryKey].splice(evt.oldIndex, 1)[0];
          galleryData[galleryKey].splice(evt.newIndex, 0, moved);
          setData(galleryData);
          renderGallery(galleryData[galleryKey], galleryKey);
        }
      });

      // Masonry 계산
      bindImgLoadReflow(el);
      sizeMasonry(el);
    }

    function renderAll() {
      const data = getData();
      for (let i = 1; i <= 10; i++) {
        renderGallery(data[`gallery${i}`] || [], `gallery${i}`);
      }
    }

    // 모달
    document.getElementById('add-btn').onclick = () => {
      editing.gallery = null;
      editing.index = null;
      document.getElementById('modal-img').value = "";
      document.getElementById('modal-link').value = "";
      document.getElementById('modal-dir').value = "gallery1";
      document.getElementById('modal-overlay').style.display = 'flex';
      document.getElementById('modal-img').focus();
    };
    document.querySelector('#modal .cancel-btn').onclick = () => {
      document.getElementById('modal-overlay').style.display = 'none';
    };
    document.querySelector('#modal .save-btn').onclick = () => {
      const img = document.getElementById('modal-img').value.trim();
      const link = document.getElementById('modal-link').value.trim();
      const dir = document.getElementById('modal-dir').value;
      if (!img) { alert("이미지 주소를 입력하세요."); return; }
      if (!link) { alert("링크 주소를 입력하세요."); return; }

      let data = getData();
      if (editing.gallery !== null && editing.index !== null) {
        if (editing.gallery === dir) {
          data[dir][editing.index] = { url: link, img };
        } else {
          data[editing.gallery].splice(editing.index, 1);
          if (!data[dir]) data[dir] = [];
          data[dir].push({ url: link, img });
        }
      } else {
        if (!data[dir]) data[dir] = [];
        data[dir].push({ url: link, img }); // 맨 뒤에 추가 => 저장 순서 유지
      }
      setData(data);
      document.getElementById('modal-overlay').style.display = 'none';
      renderAll();
    };

    // 내보내기/가져오기
    document.getElementById('export-btn').onclick = () => {
      const data = getData();
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'influencer_gallery.json';
      a.click();
      URL.revokeObjectURL(url);
    };
    document.getElementById('import-btn').onclick = () => {
      document.getElementById('import-file').click();
    };
    document.getElementById('import-file').onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const data = JSON.parse(evt.target.result);
          setData(data);
          renderAll();
          alert('가져오기가 완료되었습니다.');
        } catch {
          alert('불러오기 실패(잘못된 파일)');
        }
      };
      reader.readAsText(file);
      e.target.value = null;
    };

    // 초기 렌더 + 리사이즈 대응
    renderAll();
    window.addEventListener('resize', () => {
      // 레이아웃만 다시 계산
      sizeAllMasonry();
    });
  </script>
</body>
</html>
