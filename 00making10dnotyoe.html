<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MYWAY 인플루언서 influencer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #fff; font-family: 'Segoe UI','맑은 고딕','NanumGothic',Arial,sans-serif; margin:0; padding:0; padding-left:220px; } /* 왼쪽 패널 공간 확보 */
    .topbar {
      position: fixed; top: 0; left: 220px; width: calc(100vw - 220px); z-index: 1001;
      background: #2e2e54; color: #fff;
      display: flex; align-items: center; justify-content: flex-start;
      box-shadow: 0 4px 18px #29317018;
      padding: 0 14px; height: 54px; min-width: 360px; font-size: 16px;
    }
    .topbar button {
      padding: 8px 18px; margin-right: 8px; background: #436cff; color: #fff;
      border: none; border-radius: 6px; font-size: 15px; cursor: pointer;
      font-family: inherit; transition: background .2s;
    }
    .topbar button#export-btn { background: #30bc8a; }
    .topbar button#import-btn { background: #ffc94a; color: #232356; }
    .topbar select {
      margin-left: 8px; padding: 7px 11px; font-size: 15px; border-radius: 5px; border: 1px solid #ccd;
      background: #fff; color: #232373; min-width: 110px; font-family: inherit;
    }

    /* 대시보드: 기존처럼 아래에서 시작 (원본 유지) */
    .dashboard {
      max-width: 1200px; margin: 0 auto; padding: 64px 0 60px 0;
      margin-top: 1200px !important;
    }

    .gallery-label {
      font-weight: bold; font-size: 1.15rem; margin: 34px 0 18px 0;
      color: #232356; text-align: center; letter-spacing: 0.5px; display: block; width: 100%;
    }
    .gallery-row { width: 100%; max-width: 1080px; margin: 0 auto; text-align: center; }

    .list-row {
      display: inline-block; vertical-align: top; box-sizing: border-box;
      position: relative; transition: width 0.2s, height 0.2s; background: #fff;
    }
    .list-row:last-child { margin-right: 0; }

    .imgframe {
      width: 100%; height: 100%; background: #fff; position: relative;
      box-sizing: border-box; z-index: 0; border-radius: 0;
      box-shadow: 0 6px 6px 0 rgba(90,90,130,0.11);
      overflow: hidden; display: flex; align-items: flex-start; justify-content: center;
    }
    .img-wrap { position: relative; height: 100%; width: 100%; overflow: hidden; margin:0; padding:0;}
    .img-item { position: relative; width: 100%; height: 100%; overflow: hidden;}
    .img-item img { display: block; width: 100%; height: 100%; object-fit: contain; background: #fff; margin: 0; border: none; padding: 0; }

    .edit-btn {
      position: absolute; top: 7px; right: 9px; padding: 4px 12px; font-size: 14px;
      background: #2e2e54c0; color: #fff; border: none; border-radius: 6px; cursor: pointer;
      z-index: 4; transition: background .15s;
    }
    .edit-btn:hover { background: #436cff; }

    .shadow-line { text-align: center; margin: 0; padding: 0; max-width: 100%; overflow: hidden !important; vertical-align: top;}
    .shadow-line img { display: block; margin: 0 auto; width: 95%; height: 20px; pointer-events: none; user-select: none; }

    /* === 카드(그림) 크기: 현재 대비 +30% === */
    .list-row.magazine { width: 254px; height: 360px; margin: 0 12px 36px 0; }
    @media (max-width: 1080px) {
      .list-row.magazine {
        width: 47.3vw; height: 67.6vw;
        min-width: 135px; min-height: 169px;
        margin: 0 2vw 28px 0;
      }
    }
    @media (max-width: 700px) {
      .list-row.magazine {
        width: 74.4vw; height: 104.8vw;
        min-width: 110px; min-height: 144px;
        margin: 0 2vw 22px 0;
      }
    }

    /* === 왼쪽(별도) 디렉토리 패널 === */
    .leftdir-panel {
      position: fixed; top: 0; left: 0; z-index: 1003;
      width: 220px; height: 100vh;
      background: rgba(46,46,84,0.96);
      box-shadow: 3px 0 16px rgba(0,0,0,.18);
      color: #fff;
      display: flex; flex-direction: column;
    }
    .leftdir-topspace { height: 54px; } /* 상단바 높이만큼 빈공간 */
    .leftdir-panel .inner { padding: 12px; flex: 1 1 auto; display: flex; flex-direction: column; min-height: 0; }
    .leftdir-title { font-weight:700; font-size:15px; margin: 4px 0 10px 0; color:#ffd777; }
    .leftdir-add { display:flex; gap:6px; margin-bottom:10px; }
    .leftdir-add input {
      flex:1; padding:7px 8px; border-radius:6px; border:1px solid #5a66a8; font-size:13px; outline:none;
      background:#fff; color:#222;
    }
    .leftdir-add button {
      padding:7px 10px; border:none; border-radius:6px; background:#4067d1; color:#fff; font-size:13px; cursor:pointer;
    }
    .leftdir-list { flex: 1 1 auto; overflow:auto; padding-right:4px; }
    .leftdir-item {
      padding:7px 8px; border-radius:6px; background: #3a3a74; margin-bottom:6px;
      cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:space-between;
      transition: background .15s;
    }
    .leftdir-item:hover { background:#51519c; }
    .leftdir-item.active { outline: 2px solid #ffd777; }
    .leftdir-item span { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px; }

    /* === 모달(오버레이) 안정화: 항상 중앙, 작은 화면에서도 버튼 보이게 === */
    #modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.57);
      display: none; align-items: center; justify-content: center;
      z-index: 9999; padding: 16px; box-sizing: border-box;
    }
    #modal-overlay.show { display: flex !important; }
    #modal {
      background: #fff; padding: 22px 18px 14px 18px; border-radius: 8px;
      width: min(420px, 92vw); max-height: 90vh; overflow: auto; box-shadow: 0 2px 16px #24248238;
      position: relative;
    }
    #modal h3 { margin: 0 0 12px 0; font-size: 20px; color:#313181;}
    #modal label { display:block; margin:12px 0 6px 0; color:#232356; font-weight:600;}
    #modal input, #modal select {
      width: 100%; padding: 10px; border: 1px solid #b2c1e6; border-radius: 6px; font-size: 14px; box-sizing: border-box;
    }
    #modal .actions {
      display: flex; justify-content: flex-end; gap: 10px;
      margin-top: 16px; padding-top: 10px; border-top: 1px solid #e7ebff;
      position: sticky; bottom: 0; background: #fff; /* 버튼이 항상 보이게 */
    }
    #modal .actions button { padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; }
    #modal .save-btn { background: #4067d1; color: #fff; }
    #modal .cancel-btn { background: #dc3545; color: #fff; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>
  <!-- 왼쪽 ‘별도’ 디렉토리 패널 -->
  <aside class="leftdir-panel" id="leftdir-panel" aria-label="left directories">
    <div class="leftdir-topspace"></div>
    <div class="inner">
      <div class="leftdir-title">왼쪽 디렉토리</div>
      <div class="leftdir-add">
        <input type="text" id="leftdir-input" placeholder="새 디렉토리 이름">
        <button id="leftdir-add-btn" type="button">추가</button>
      </div>
      <div class="leftdir-list" id="leftdir-list"></div>
    </div>
  </aside>

  <!-- 상단바 -->
  <nav class="topbar">
    <button id="add-btn">추가</button>
    <button id="export-btn">내보내기</button>
    <button id="import-btn">가져오기</button>
    <input type="file" id="import-file" accept="application/json" style="display:none">
    <select id="page-switch">
      <option value="">Type</option>
      <option value="making001.html">BAR ▼</option>
      <option value="00making77typeshort.html">PIC1 ▼</option>
      <option value="00makingcircletext.html">CIRCLE▼</option>
      <option value="00making10d.html.html">PIC2 ▼</option>
    </select>
  </nav>

  <!-- 본문 (중앙 디렉토리 A~J) -->
  <div class="dashboard" id="dashboard">
    <span class="gallery-label" id="label-gallery1">A</span>
    <div class="gallery-row" id="gallery1"></div>
    <span class="gallery-label" id="label-gallery2">B</span>
    <div class="gallery-row" id="gallery2"></div>
    <span class="gallery-label" id="label-gallery3">C</span>
    <div class="gallery-row" id="gallery3"></div>
    <span class="gallery-label" id="label-gallery4">D</span>
    <div class="gallery-row" id="gallery4"></div>
    <span class="gallery-label" id="label-gallery5">E</span>
    <div class="gallery-row" id="gallery5"></div>
    <span class="gallery-label" id="label-gallery6">F</span>
    <div class="gallery-row" id="gallery6"></div>
    <span class="gallery-label" id="label-gallery7">G</span>
    <div class="gallery-row" id="gallery7"></div>
    <span class="gallery-label" id="label-gallery8">H</span>
    <div class="gallery-row" id="gallery8"></div>
    <span class="gallery-label" id="label-gallery9">I</span>
    <div class="gallery-row" id="gallery9"></div>
    <span class="gallery-label" id="label-gallery10">J</span>
    <div class="gallery-row" id="gallery10"></div>
  </div>

  <!-- 입력 모달 (중앙+왼쪽 선택) -->
  <div id="modal-overlay">
    <div id="modal">
      <h3>이미지 추가</h3>
      <label>이미지 URL</label>
      <input type="text" id="modal-img" placeholder="이미지 주소">
      <label>링크 URL</label>
      <input type="text" id="modal-link" placeholder="연결될 링크 주소">

      <label>중앙 디렉토리(기존)</label>
      <select id="modal-dir">
        <option value="gallery1">A</option>
        <option value="gallery2">B</option>
        <option value="gallery3">C</option>
        <option value="gallery4">D</option>
        <option value="gallery5">E</option>
        <option value="gallery6">F</option>
        <option value="gallery7">G</option>
        <option value="gallery8">H</option>
        <option value="gallery9">I</option>
        <option value="gallery10">J</option>
      </select>

      <label>왼쪽 디렉토리(별도)</label>
      <select id="modal-leftdir">
        <option value="">(선택 없음)</option>
        <!-- 동적 추가 -->
      </select>

      <div class="actions">
        <button class="cancel-btn" type="button">취소</button>
        <button class="save-btn" type="button">저장</button>
      </div>
    </div>
  </div>

  <script>
    // 페이지 이동
    document.getElementById('page-switch').addEventListener('change', function() {
      if (this.value) location.href = this.value;
    });

    // ===== Storage 키 =====
    const STORAGE_NAMESPACE = "MW_INFLUENCER_GALLERY_v3";
    const PAGE_ID = (location.pathname.split('/').pop() || 'index').toLowerCase();
    const STORAGE_KEY = `${STORAGE_NAMESPACE}:${PAGE_ID}`;   // 중앙 디렉토리 데이터
    const LEFTDIRS_KEY = `${STORAGE_KEY}:left_dirs`;         // 왼쪽 디렉토리 목록

    // 기본 데이터
    const defaultData = {
      gallery1: [
        { url: "https://www.youtube.com/@popcorncokemovie/videos",
          img: "https://yt3.googleusercontent.com/4vsl0dMmf2_zJh9hNMoFP7KPnfxEKCeWSn5iYdQvuJUVUkBf9eFu3qqdHWIN1DDULygUcGDmww=s900-c-k-c0x00ffffff-no-rj"
        },
      ],
      gallery2: [], gallery3: [], gallery4: [], gallery5: [],
      gallery6: [], gallery7: [], gallery8: [], gallery9: [], gallery10: []
    };
    const shadowUrl = "https://64.media.tumblr.com/f5f06009df6584ebb5539cad61f73c63/tumblr_inline_qsghz3XZRQ1r45nlo_500.png";

    // Helpers
    function getData() {
      let data = localStorage.getItem(STORAGE_KEY);
      if (!data) return JSON.parse(JSON.stringify(defaultData));
      try { return JSON.parse(data); } catch { return JSON.parse(JSON.stringify(defaultData)); }
    }
    function setData(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    function getLeftDirs() { try { return JSON.parse(localStorage.getItem(LEFTDIRS_KEY) || "[]"); } catch { return []; } }
    function setLeftDirs(list) { localStorage.setItem(LEFTDIRS_KEY, JSON.stringify(list)); }

    let currentLeftDirId = "";   // 모달 기본값
    let activeLeftFilter = "";   // 필터 상태 (''=전체)

    let editing = { gallery: null, index: null, originalIndex: null };

    // 갤러리 렌더
    function renderGallery(arr, targetId) {
      const el = document.getElementById(targetId);
      if (!el) return;

      el.innerHTML = (arr || []).map((item, idx) => `
        <div class="list-row magazine" data-idx="${idx}">
          <div class="imgframe">
            <button class="edit-btn" type="button" title="수정">수정</button>
            <div class="img-wrap magazine">
              <div class="img-item magazine">
                <a href="${item.url}" target="_blank" rel="noopener">
                  <img src="${item.img}">
                </a>
              </div>
            </div>
          </div>
          <div class="shadow-line">
            <img src="${shadowUrl}">
          </div>
        </div>
      `).join('');

      // 수정 버튼
      Array.from(el.querySelectorAll('.edit-btn')).forEach((btn, idx) => {
        btn.onclick = function(e) {
          e.stopPropagation();
          editing.gallery = targetId;
          // 원본 인덱스 매핑 (필터중이면 원본에서 찾아서 저장)
          const full = getData()[targetId] || [];
          const filtered = activeLeftFilter ? full.filter(x => (x.leftDir || "") === activeLeftFilter) : full;
          const item = filtered[idx];
          const originalIndex = full.indexOf(item);
          editing.index = idx;
          editing.originalIndex = originalIndex;

          document.getElementById('modal-img').value = item?.img || "";
          document.getElementById('modal-link').value = item?.url || "";
          document.getElementById('modal-dir').value = targetId;
          refreshLeftDirOptions();
          document.getElementById('modal-leftdir').value = item?.leftDir || currentLeftDirId || "";
          document.getElementById('modal-overlay').classList.add('show');
        };
      });

      // 드래그 정렬 (필터 중 비활성)
      if (!activeLeftFilter) {
        Sortable.create(el, {
          animation: 160,
          handle: ".imgframe",
          ghostClass: "drag-ghost",
          onEnd: function (evt) {
            const data = getData();
            const moved = data[targetId].splice(evt.oldIndex, 1)[0];
            data[targetId].splice(evt.newIndex, 0, moved);
            setData(data);
            renderAll();
          }
        });
      }
    }

    // 전체 렌더 (필터 적용)
    function renderAll() {
      const data = getData();
      for (let i = 1; i <= 10; i++) {
        const id = `gallery${i}`;
        const full = data[id] || [];
        const filtered = activeLeftFilter ? full.filter(x => (x.leftDir || "") === activeLeftFilter) : full;
        renderGallery(filtered, id);
      }
      renderLeftDirPanel();
    }

    // 왼쪽 패널 렌더
    function renderLeftDirPanel() {
      const listEl = document.getElementById('leftdir-list');
      listEl.innerHTML = '';

      // 전체 보기
      const allItem = document.createElement('div');
      allItem.className = 'leftdir-item' + (activeLeftFilter === '' ? ' active' : '');
      allItem.innerHTML = `<span>전체 보기</span>`;
      allItem.onclick = () => { activeLeftFilter = ''; currentLeftDirId=''; renderAll(); };
      listEl.appendChild(allItem);

      const leftDirs = getLeftDirs();
      if (leftDirs.length === 0) {
        const empty = document.createElement('div');
        empty.style.opacity = .9; empty.style.fontSize = '13px'; empty.style.marginTop = '6px';
        empty.textContent = '왼쪽 디렉토리를 추가하세요.';
        listEl.appendChild(empty);
        return;
      }

      leftDirs.forEach(dir => {
        const item = document.createElement('div');
        item.className = 'leftdir-item' + (activeLeftFilter === dir.id ? ' active' : '');
        item.innerHTML = `<span>${dir.name}</span>`;
        item.onclick = () => { activeLeftFilter = dir.id; currentLeftDirId = dir.id; renderAll(); };
        listEl.appendChild(item);
      });
    }

    // 모달 왼쪽 디렉토리 셀렉트 동기화
    function refreshLeftDirOptions() {
      const sel = document.getElementById('modal-leftdir');
      const prev = sel.value;
      sel.innerHTML = '';
      const none = document.createElement('option'); none.value = ''; none.textContent = '(선택 없음)';
      sel.appendChild(none);
      getLeftDirs().forEach(dir => {
        const opt = document.createElement('option'); opt.value = dir.id; opt.textContent = dir.name;
        sel.appendChild(opt);
      });
      sel.value = currentLeftDirId || prev || '';
    }

    // 모달 열기 (추가)
    document.getElementById('add-btn').onclick = () => {
      editing = { gallery: null, index: null, originalIndex: null };
      document.getElementById('modal-img').value = "";
      document.getElementById('modal-link').value = "";
      document.getElementById('modal-dir').value = "gallery1";
      refreshLeftDirOptions();
      document.getElementById('modal-leftdir').value = currentLeftDirId || '';
      document.getElementById('modal-overlay').classList.add('show');
    };

    // 모달 취소
    document.querySelector('#modal .cancel-btn').onclick = () => {
      document.getElementById('modal-overlay').classList.remove('show');
    };

    // 모달 저장
    document.querySelector('#modal .save-btn').onclick = () => {
      const img = document.getElementById('modal-img').value.trim();
      const link = document.getElementById('modal-link').value.trim();
      const dir = document.getElementById('modal-dir').value;
      const leftDir = document.getElementById('modal-leftdir').value;

      if (!img) { alert("이미지 주소를 입력하세요."); return; }
      if (!link) { alert("링크 주소를 입력하세요."); return; }

      const payload = { url: link, img, leftDir: leftDir || "" };
      const data = getData();
      if (!data[dir]) data[dir] = [];

      // 새로 추가 or 편집 반영
      if (editing.gallery === null) {
        data[dir].push(payload);
      } else {
        const originArr = data[editing.gallery] || [];
        if (editing.originalIndex != null && originArr[editing.originalIndex]) {
          if (editing.gallery === dir) {
            originArr[editing.originalIndex] = payload;
            data[editing.gallery] = originArr;
          } else {
            originArr.splice(editing.originalIndex, 1);
            data[dir].push(payload);
          }
        } else {
          // 안전장치: 원본 인덱스를 못 찾으면 해당 디렉토리에 추가
          data[dir].push(payload);
        }
      }

      setData(data);
      document.getElementById('modal-overlay').classList.remove('show');
      renderAll();
    };

    // 왼쪽 디렉토리 추가
    document.getElementById('leftdir-add-btn').onclick = () => {
      const inp = document.getElementById('leftdir-input');
      const name = (inp.value || '').trim();
      if (!name) { inp.focus(); return; }
      const id = `leftdir_${Date.now().toString(36)}`;
      const dirs = getLeftDirs();
      dirs.push({ id, name });
      setLeftDirs(dirs);
      currentLeftDirId = id; activeLeftFilter = id;
      inp.value = '';
      renderAll();
    };

    // 내보내기/가져오기
    document.getElementById('export-btn').onclick = () => {
      const payload = { data: getData(), leftDirs: getLeftDirs() };
      const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'influencer_gallery.json'; a.click();
      URL.revokeObjectURL(url);
    };
    document.getElementById('import-btn').onclick = () => document.getElementById('import-file').click();
    document.getElementById('import-file').onchange = e => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const parsed = JSON.parse(evt.target.result);
          if (parsed && parsed.data && parsed.leftDirs) {
            setData(parsed.data); setLeftDirs(parsed.leftDirs);
          } else { setData(parsed); }
          activeLeftFilter=''; currentLeftDirId='';
          renderAll();
          alert('가져오기가 완료되었습니다.');
        } catch { alert('불러오기 실패(잘못된 파일)'); }
      };
      reader.readAsText(file); e.target.value = null;
    };

    // 초기 렌더
    renderAll();
  </script>
</body>
</html>
