<!DOCTYPE html>
<html lang="ko">
<head>
  <base target="_blank">
  <meta charset="UTF-8">
  <title>그림 그리드 - 순서보존 Masonry (Export/Import 포함)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{
      --gap:15px;
      --row-unit:8px;
      --side-pad:12px;
    }
    body{margin:0;padding:0;font-family:'Segoe UI','맑은 고딕','NanumGothic',Arial,sans-serif;}

    .topbar{
      position:fixed; top:0; left:0; right:0; z-index:1100;
      height:58px; padding:0 16px;
      display:flex; align-items:center; gap:8px;
      background:rgba(54,56,110,.98); color:#fff;
      box-shadow:0 4px 18px #29317020;
    }
    .topbar button{
      padding:7px 14px; border:none; border-radius:6px; cursor:pointer;
      background:#313181; color:#fff; font-size:15px;
    }
    #export-btn{ background:#21b781; }
    #import-btn{ background:#ffe178; color:#222; }

    /* Masonry(Grid) – DOM 순서 보존 */
    #media-grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);  /* PC 3열 */
      grid-auto-rows: var(--row-unit);       /* Masonry 단위행 */
      grid-auto-flow: row;                   /* dense 금지 → 순서 보존 */
      gap: var(--gap);
      max-width:1400px;
      padding:0 var(--side-pad);
      margin: 1250px auto 20px;              /* 요청대로 아래서 시작 */
    }
    @media (max-width:1100px){ #media-grid{ grid-template-columns:repeat(2,1fr); } }
    @media (max-width:600px){  #media-grid{ grid-template-columns:1fr; } }

    .grid-item{
      position:relative; overflow:hidden; border-radius:10px; background:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.12);
      will-change: grid-row-end;
    }
    .grid-item img{
      width:100%; height:auto; display:block; transition:transform .25s ease;
    }
    .grid-item:hover img{ transform:scale(1.03); }
    .edit-btn{
      position:absolute; top:8px; right:8px; z-index:2;
      padding:4px 6px; font-size:12px; border:none; border-radius:4px;
      background:rgba(0,0,0,.6); color:#fff; cursor:pointer;
    }

    /* 모달 */
    #modal-overlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.6); z-index:2000;
    }
    .modal{
      width:320px; background:#fff; border-radius:8px; padding:18px; box-shadow:0 2px 16px rgba(0,0,0,.35);
    }
    .modal h3{ margin:0 0 12px; font-size:18px; }
    .modal input{
      width:100%; padding:8px; margin:0 0 10px;
      border:1px solid #cbd2e1; border-radius:6px; font-size:14px;
    }
    .modal .row{ display:flex; gap:8px; justify-content:flex-end; }
    .modal .row button{ padding:8px 12px; border:none; border-radius:6px; cursor:pointer; }
    #cancel-btn{ background:#dc3545; color:#fff; }
    #confirm-btn{ background:#4067d1; color:#fff; }
  </style>
</head>
<body>
  <nav class="topbar">
    <button id="add-btn">사진 저장</button>
    <button id="export-btn">내보내기</button>
    <button id="import-btn">가져오기</button>
    <input type="file" id="import-file" accept="application/json" style="display:none">
  </nav>

  <div id="media-grid"></div>

  <!-- 입력 모달 -->
  <div id="modal-overlay">
    <div class="modal">
      <h3>사진 추가</h3>
      <input type="text" id="img-url" placeholder="이미지 URL">
      <input type="text" id="link-url" placeholder="연결 링크(URL)">
      <div class="row">
        <button id="cancel-btn">취소</button>
        <button id="confirm-btn">저장</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script>
    const STORAGE_KEY = 'mediaList_order_masonry_v1';

    const grid   = document.getElementById('media-grid');
    const addBtn = document.getElementById('add-btn');
    const expBtn = document.getElementById('export-btn');
    const impBtn = document.getElementById('import-btn');
    const impInp = document.getElementById('import-file');

    const overlay = document.getElementById('modal-overlay');
    const imgInp  = document.getElementById('img-url');
    const linkInp = document.getElementById('link-url');
    const okBtn   = document.getElementById('confirm-btn');
    const cancel  = document.getElementById('cancel-btn');

    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

    function getList(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch{ return []; }
    }
    function setList(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    // Masonry 계산: 각 카드 높이 → span
    function layoutMasonry(){
      const styles = getComputedStyle(grid);
      const rowH = parseInt(styles.gridAutoRows) || 8;
      const gap  = parseInt(styles.gap) || 0;
      $$('.grid-item').forEach(item=>{
        item.style.gridRowEnd = 'auto';
        const total = item.offsetHeight + gap;
        const span  = Math.max(1, Math.ceil(total / rowH));
        item.style.gridRowEnd = `span ${span}`;
      });
    }
    window.addEventListener('resize', layoutMasonry);

    function bindImgLoad(container=grid){
      $$('img', container).forEach(img=>{
        if (img.complete) return;
        img.addEventListener('load', layoutMasonry, {once:true});
      });
    }

    function render(){
      const list = getList();
      grid.innerHTML = '';
      list.forEach((it, idx)=>{
        const card = document.createElement('div');
        card.className = 'grid-item';

        const img = document.createElement('img');
        img.src = it.imgUrl;
        img.alt = '';
        img.onerror = function(){ this.src = 'https://via.placeholder.com/600x400/cccccc/ffffff?text=Image+Not+Found'; }
        img.addEventListener('click', ()=> window.open(it.linkUrl, '_blank','noopener'));

        const edit = document.createElement('button');
        edit.className = 'edit-btn';
        edit.textContent = '삭제';
        edit.addEventListener('click', (e)=>{
          e.stopPropagation();
          const arr = getList();
          arr.splice(idx,1);
          setList(arr);
          render();
        });

        card.append(img, edit);
        grid.append(card);
      });

      // 드래그로 순서 변경 (저장 순서 = 표시 순서)
      Sortable.create(grid, {
        animation: 150,
        onEnd: (evt)=>{
          const arr = getList();
          const [moved] = arr.splice(evt.oldIndex,1);
          arr.splice(evt.newIndex,0,moved);
          setList(arr);
          render();
        }
      });

      bindImgLoad();
      layoutMasonry();
    }

    // 모달
    addBtn.onclick = ()=>{ overlay.style.display='flex'; imgInp.value=''; linkInp.value=''; imgInp.focus(); };
    cancel.onclick = ()=>{ overlay.style.display='none'; };
    okBtn.onclick = ()=>{
      const img = imgInp.value.trim();
      let link = linkInp.value.trim();
      if(!img){ alert('이미지 URL을 입력하세요.'); imgInp.focus(); return; }
      if(!link){ alert('링크 URL을 입력하세요.'); linkInp.focus(); return; }
      if(!/^https?:\/\//i.test(link)) link = 'https://' + link;
      const arr = getList();
      arr.push({imgUrl: img, linkUrl: link});  // 맨 뒤에 추가 → 순서 보존
      setList(arr);
      overlay.style.display='none';
      render();
    };

    // 내보내기
    expBtn.onclick = ()=>{
      const data = { mediaList: getList() };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = 'mediaList.json'; a.click();
      URL.revokeObjectURL(url);
    };

    // 가져오기 (두 포맷 모두 허용: 배열 또는 {mediaList:[…]})
    impBtn.onclick = ()=> impInp.click();
    impInp.onchange = e=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = evt=>{
        try{
          let parsed = JSON.parse(evt.target.result);
          let list;
          if(Array.isArray(parsed)) list = parsed;
          else if(parsed && Array.isArray(parsed.mediaList)) list = parsed.mediaList;
          else throw new Error('형식 오류');
          // 최소 필드 검증
          list = list.filter(x=>x && typeof x.imgUrl==='string' && typeof x.linkUrl==='string');
          setList(list);
          render();
          alert('가져오기 완료!');
        }catch(err){
          alert('가져오기 실패: 올바른 JSON 파일인지 확인하세요.');
        }finally{
          e.target.value = null;
        }
      };
      reader.readAsText(file);
    };

    // 초기 렌더
    render();
  </script>
</body>
</html>
